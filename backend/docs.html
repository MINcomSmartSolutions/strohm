<!DOCTYPE html>
<html lang="" xml:lang="" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8"/>
    <meta content="pandoc" name="generator"/>
    <meta content="width=device-width, initial-scale=1.0, user-scalable=yes" name="viewport"/>
    <title>api</title>
    <style>
        html {
            color: #1a1a1a;
            background-color: #fdfdfd;
        }

        body {
            margin: 0 auto;
            max-width: 36em;
            padding-left: 50px;
            padding-right: 50px;
            padding-top: 50px;
            padding-bottom: 50px;
            hyphens: auto;
            overflow-wrap: break-word;
            text-rendering: optimizeLegibility;
            font-kerning: normal;
        }

        @media (max-width: 600px) {
            body {
                font-size: 0.9em;
                padding: 12px;
            }

            h1 {
                font-size: 1.8em;
            }
        }

        @media print {
            html {
                background-color: white;
            }

            body {
                background-color: transparent;
                color: black;
                font-size: 12pt;
            }

            p, h2, h3 {
                orphans: 3;
                widows: 3;
            }

            h2, h3, h4 {
                page-break-after: avoid;
            }
        }

        p {
            margin: 1em 0;
        }

        a {
            color: #1a1a1a;
        }

        a:visited {
            color: #1a1a1a;
        }

        img {
            max-width: 100%;
        }

        svg {
            height: auto;
            max-width: 100%;
        }

        h1, h2, h3, h4, h5, h6 {
            margin-top: 1.4em;
        }

        h5, h6 {
            font-size: 1em;
            font-style: italic;
        }

        h6 {
            font-weight: normal;
        }

        ol, ul {
            padding-left: 1.7em;
            margin-top: 1em;
        }

        li > ol, li > ul {
            margin-top: 0;
        }

        blockquote {
            margin: 1em 0 1em 1.7em;
            padding-left: 1em;
            border-left: 2px solid #e6e6e6;
            color: #606060;
        }

        code {
            font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
            font-size: 85%;
            margin: 0;
            hyphens: manual;
        }

        pre {
            margin: 1em 0;
            overflow: auto;
        }

        pre code {
            padding: 0;
            overflow: visible;
            overflow-wrap: normal;
        }

        .sourceCode {
            background-color: transparent;
            overflow: visible;
        }

        hr {
            border: none;
            border-top: 1px solid #1a1a1a;
            height: 1px;
            margin: 1em 0;
        }

        table {
            margin: 1em 0;
            border-collapse: collapse;
            width: 100%;
            overflow-x: auto;
            display: block;
            font-variant-numeric: lining-nums tabular-nums;
        }

        table caption {
            margin-bottom: 0.75em;
        }

        tbody {
            margin-top: 0.5em;
            border-top: 1px solid #1a1a1a;
            border-bottom: 1px solid #1a1a1a;
        }

        th {
            border-top: 1px solid #1a1a1a;
            padding: 0.25em 0.5em 0.25em 0.5em;
        }

        td {
            padding: 0.125em 0.5em 0.25em 0.5em;
        }

        header {
            margin-bottom: 4em;
            text-align: center;
        }

        #TOC li {
            list-style: none;
        }

        #TOC ul {
            padding-left: 1.3em;
        }

        #TOC > ul {
            padding-left: 0;
        }

        #TOC a:not(:hover) {
            text-decoration: none;
        }

        code {
            white-space: pre-wrap;
        }

        span.smallcaps {
            font-variant: small-caps;
        }

        div.columns {
            display: flex;
            gap: min(4vw, 1.5em);
        }

        div.column {
            flex: auto;
            overflow-x: auto;
        }

        div.hanging-indent {
            margin-left: 1.5em;
            text-indent: -1.5em;
        }

        /* The extra [class] is a hack that increases specificity enough to
           override a similar rule in reveal.js */
        ul.task-list[class] {
            list-style: none;
        }

        ul.task-list li input[type="checkbox"] {
            font-size: inherit;
            width: 0.8em;
            margin: 0 0.8em 0.2em -1.6em;
            vertical-align: middle;
        }

        .display.math {
            display: block;
            text-align: center;
            margin: 0.5rem auto;
        }

        /* CSS for syntax highlighting */
        html {
            -webkit-text-size-adjust: 100%;
        }

        pre > code.sourceCode {
            white-space: pre;
            position: relative;
        }

        pre > code.sourceCode > span {
            display: inline-block;
            line-height: 1.25;
        }

        pre > code.sourceCode > span:empty {
            height: 1.2em;
        }

        .sourceCode {
            overflow: visible;
        }

        code.sourceCode > span {
            color: inherit;
            text-decoration: inherit;
        }

        div.sourceCode {
            margin: 1em 0;
        }

        pre.sourceCode {
            margin: 0;
        }

        @media screen {
            div.sourceCode {
                overflow: auto;
            }
        }

        @media print {
            pre > code.sourceCode {
                white-space: pre-wrap;
            }

            pre > code.sourceCode > span {
                text-indent: -5em;
                padding-left: 5em;
            }
        }

        pre.numberSource code {
            counter-reset: source-line 0;
        }

        pre.numberSource code > span {
            position: relative;
            left: -4em;
            counter-increment: source-line;
        }

        pre.numberSource code > span > a:first-child::before {
            content: counter(source-line);
            position: relative;
            left: -1em;
            text-align: right;
            vertical-align: baseline;
            border: none;
            display: inline-block;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            padding: 0 4px;
            width: 4em;
            color: #aaaaaa;
        }

        pre.numberSource {
            margin-left: 3em;
            border-left: 1px solid #aaaaaa;
            padding-left: 4px;
        }

        div.sourceCode {
        }

        @media screen {
            pre > code.sourceCode > span > a:first-child::before {
                text-decoration: underline;
            }
        }

        code span.al {
            color: #ff0000;
            font-weight: bold;
        }

        /* Alert */
        code span.an {
            color: #60a0b0;
            font-weight: bold;
            font-style: italic;
        }

        /* Annotation */
        code span.at {
            color: #7d9029;
        }

        /* Attribute */
        code span.bn {
            color: #40a070;
        }

        /* BaseN */
        code span.bu {
            color: #008000;
        }

        /* BuiltIn */
        code span.cf {
            color: #007020;
            font-weight: bold;
        }

        /* ControlFlow */
        code span.ch {
            color: #4070a0;
        }

        /* Char */
        code span.cn {
            color: #880000;
        }

        /* Constant */
        code span.co {
            color: #60a0b0;
            font-style: italic;
        }

        /* Comment */
        code span.cv {
            color: #60a0b0;
            font-weight: bold;
            font-style: italic;
        }

        /* CommentVar */
        code span.do {
            color: #ba2121;
            font-style: italic;
        }

        /* Documentation */
        code span.dt {
            color: #902000;
        }

        /* DataType */
        code span.dv {
            color: #40a070;
        }

        /* DecVal */
        code span.er {
            color: #ff0000;
            font-weight: bold;
        }

        /* Error */
        code span.ex {
        }

        /* Extension */
        code span.fl {
            color: #40a070;
        }

        /* Float */
        code span.fu {
            color: #06287e;
        }

        /* Function */
        code span.im {
            color: #008000;
            font-weight: bold;
        }

        /* Import */
        code span.in {
            color: #60a0b0;
            font-weight: bold;
            font-style: italic;
        }

        /* Information */
        code span.kw {
            color: #007020;
            font-weight: bold;
        }

        /* Keyword */
        code span.op {
            color: #666666;
        }

        /* Operator */
        code span.ot {
            color: #007020;
        }

        /* Other */
        code span.pp {
            color: #bc7a00;
        }

        /* Preprocessor */
        code span.sc {
            color: #4070a0;
        }

        /* SpecialChar */
        code span.ss {
            color: #bb6688;
        }

        /* SpecialString */
        code span.st {
            color: #4070a0;
        }

        /* String */
        code span.va {
            color: #19177c;
        }

        /* Variable */
        code span.vs {
            color: #4070a0;
        }

        /* VerbatimString */
        code span.wa {
            color: #60a0b0;
            font-weight: bold;
            font-style: italic;
        }

        /* Warning */
    </style>
</head>
<body>
<h2 id="modules">Modules</h2>
<dl>
    <dt>
        <a href="#module_app">app</a>
    </dt>
    <dd>
        <p>
            Express app instance.
        </p>
    </dd>
    <dt>
        <a href="#module_services/cron">services/cron</a>
    </dt>
    <dd>
        <p>
            Cron job service for periodic transaction fetching.
        </p>
        <ul>
            <li>
                Schedules a job to run every 20 second.
            </li>
            <li>
                Calls runIncremental to fetch new transactions.
            </li>
            <li>
                Logs the result after each execution.
            </li>
        </ul>
    </dd>
    <dt>
        <a href="#module_services/network">services/network</a>
    </dt>
    <dd>
        <p>
            Network service module for external API clients.
        </p>
        <ul>
            <li>
                Exports pre-configured Axios instances for Odoo and SteVe APIs.
            </li>
            <li>
                Tests connections to SteVe and Odoo on module load.
            </li>
        </ul>
    </dd>
    <dt>
        <a href="#module_services/odoo">services/odoo</a>
    </dt>
    <dd>
        <p>
            Odoo integration service: user creation, login, key rotation, and
            invoicing API.
        </p>
    </dd>
    <dt>
        <a href="#module_services/steve_transactions">services/steve_transactions</a>
    </dt>
    <dd>
        <p>
            Incremental fetch of STOPPED transactions since last high‑water mark
            (T0).
        </p>
        <p>
            High‑Water Mark Concept: We persist the timestamp of the latest
            processed transaction (the “high‑water mark” or T0). On each run, we
            only fetch transactions whose stopTimestamp is strictly greater than T0.
            After processing, we update T0 to the maximum stopTimestamp seen. This
            ensures: • No overlap or reprocessing of already handled transactions. •
            No gaps: even if a transaction ends just after T0, it will be fetched
            next run. • Linear, efficient incremental retrieval without maintaining
            complex windows.
        </p>
    </dd>
    <dt>
        <a href="#module_services/steve_user">services/steve_user</a>
    </dt>
    <dd>
        <p>
            SteVe User Service
        </p>
        <p>
            Provides functions to create, fetch, block, and unblock users in the
            SteVe OCPP backend.
        </p>
        <ul>
            <li>
                createSteveUser: Creates a new user in SteVe with the given RFID.
            </li>
            <li>
                getSteveUser: Fetches a user from SteVe by RFID.
            </li>
            <li>
                blockSteveUser: Blocks a user in SteVe (sets maxActiveTransactionCount
                to 0).
            </li>
            <li>
                unblockSteveUser: Unblocks a user in SteVe (sets
                maxActiveTransactionCount to 1).
            </li>
        </ul>
        <p>
            All functions validate input and handle errors using custom error types.
        </p>
    </dd>
    <dt>
        <a href="#module_utils/oidc_config">utils/oidc_config</a>
    </dt>
    <dd>
        <p>
            OIDC configuration for authentication middleware.
        </p>
        <ul>
            <li>
                Uses environment variables for secrets and endpoints.
            </li>
            <li>
                Customizes authorization parameters and routes.
            </li>
            <li>
                Handles user session after authentication callback.
            </li>
        </ul>
    </dd>
    <dt>
        <a href="#module_utils/steve">utils/steve</a>
    </dt>
    <dd>
        <p>
            Utility functions for Steve user data.
        </p>
    </dd>
    <dt>
        <a href="#module_app">app</a>
    </dt>
    <dd>
        <p>
            Express app instance.
        </p>
    </dd>
</dl>
<h2 id="classes">Classes</h2>
<dl>
    <dt>
        <a href="#AppError">AppError</a>
    </dt>
    <dd>
        <p>
            Base class for custom application errors
        </p>
    </dd>
</dl>
<h2 id="constants">Constants</h2>
<dl>
    <dt>
        <a href="#winston">winston</a> :
        <code><a href="#winston">winston</a></code>
    </dt>
    <dd>
        <p>
            Creates a logger instance with specified configuration.
        </p>
    </dd>
    <dt>
        <a href="#logger">logger</a>
    </dt>
    <dd>
        <p>
            Application Error Codes
        </p>
        <p>
            This module defines standardized error codes and messages for the
            application. Errors are grouped by category and include codes, HTTP
            status codes, and messages.
        </p>
    </dd>
</dl>
<h2 id="functions">Functions</h2>
<dl>
    <dt>
        <a href="#generateOdooHash">generateOdooHash(message, secret)</a> =>
        <code>string</code>
    </dt>
    <dd>
        <p>
            Generate HMAC signature matching Odoo implementation
        </p>
    </dd>
    <dt>
        <a href="#generateSalt">generateSalt(length)</a> => <code>string</code>
    </dt>
    <dd>
        <p>
            Generate a cryptographically secure random salt
        </p>
    </dd>
    <dt>
        <a href="#identifyUser">identifyUser(identifier, options)</a> =>
        <code>Promise.&lt;Object&gt;</code>
    </dt>
    <dd>
        <p>
            Gets a user by either user_id or oauth_id
        </p>
    </dd>
    <dt>
        <a href="#userOperations">userOperations(oidc_user)</a> =>
        <code>Promise.&lt;Object&gt;</code>
    </dt>
    <dd>
        <p>
            Handles user creation and linking with external systems.
        </p>
        <ul>
            <li>
                Checks if a user exists by OIDC ID.
            </li>
            <li>
                If not, creates a new user with a random RFID (for development).
            </li>
            <li>
                Ensures the user is registered in Odoo and Steve systems.
            </li>
            <li>
                Returns the up-to-date user object.
            </li>
        </ul>
    </dd>
    <dt>
        <a href="#fmt">fmt(dt, toUTC)</a> => <code>string</code>
    </dt>
    <dd>
        <p>
            Format a Luxon DateTime into SteVe's expected ISO string (no Z)
        </p>
    </dd>
    <dt>
        <a href="#createError">createError(errorDef, [customMessage],
            [originalError])</a> => <code>Object</code>
    </dt>
    <dd>
        <p>
            Create an application error with standard format
        </p>
    </dd>
    <dt>
        <a href="#appErrorHandler">appErrorHandler()</a>
    </dt>
    <dd>
        <p>
            Express error handler for AppErrors
        </p>
    </dd>
    <dt>
        <a href="#handleQueryError">handleQueryError(error, operation)</a>
    </dt>
    <dd>
        <p>
            Handles query errors.
        </p>
    </dd>
    <dt>
        <a href="#getUsers">getUsers(filters, options)</a> =>
        <code>Promise.&lt;Array&gt;</code>
    </dt>
    <dd>
        <p>
            Gets users based on dynamic filter parameters.
        </p>
    </dd>
    <dt>
        <a href="#getUserUnique">getUserUnique(filters)</a> =>
        <code>Promise.&lt;(Object|null)&gt;</code>
    </dt>
    <dd>
        <p>
            Gets a single user with uniqueness validation. Throws an error if
            multiple users match the criteria.
        </p>
    </dd>
    <dt>
        <a href="#getUserOdooCredentials">getUserOdooCredentials(user_id)</a> =>
        <code>Promise.&lt;(Object|null)&gt;</code>
    </dt>
    <dd>
        <p>
            Retrieves the latest valid Odoo API key credentials for a user. Returns
            null if no credentials are found.
        </p>
    </dd>
    <dt>
        <a href="#rotateOdooUserKey">rotateOdooUserKey(user_id, old_key_id,
            new_key, new_key_salt)</a> => <code>Promise.&lt;boolean&gt;</code>
    </dt>
    <dd>
        <p>
            Rotates a user's Odoo API key. Revokes the old key and inserts a new one
            for the user.
        </p>
    </dd>
    <dt>
        <a href="#setSteveUserParamaters">setSteveUserParamaters(user,
            steve_id)</a> => <code>Promise.&lt;(Object|undefined)&gt;</code>
    </dt>
    <dd>
        <p>
            Sets the SteVe user ID for a user in the database.
        </p>
    </dd>
    <dt>
        <a href="#recordActivityLog">recordActivityLog(user_id, event_type,
            target, rfid)</a>
    </dt>
    <dd>
        <p>
            Records an activity event for a user in the activity log.
        </p>
    </dd>
    <dt>
        <a href="#recordTransaction">recordTransaction(tx)</a> =>
        <code>Promise.&lt;Object&gt;</code>
    </dt>
    <dd>
        <p>
            Record a transaction record into the <code>charging_transactions</code>
            table. If transaction already exists and is complete, returns it without
            modification. Otherwise, inserts a new record with proper user
            association.
        </p>
    </dd>
    <dt>
        <a href="#setLastStopTimestamp">setLastStopTimestamp(new_watermark)</a>
        => <code>Promise.&lt;void&gt;</code>
    </dt>
    <dd>
        <p>
            Sets the last stop timestamp watermark. Inserts or updates the
            <code>watermark</code> table with the given timestamp.
        </p>
    </dd>
    <dt>
        <a href="#getLastStopTimestamp">getLastStopTimestamp()</a> =>
        <code>Promise.&lt;(DateTime|null)&gt;</code>
    </dt>
    <dd>
        <p>
            Retrieves the most recent <code>last_stop_timestamp</code> from the
            watermark table. Returns a Luxon DateTime if found, otherwise null.
        </p>
    </dd>
    <dt>
        <a href="#saveInvoiceId">saveInvoiceId(txn, invoice_id)</a> =>
        <code>Promise.&lt;void&gt;</code>
    </dt>
    <dd>
        <p>
            Updates the <code>invoice_ref</code> field for a transaction in
            <code>charging_transactions</code>.
        </p>
    </dd>
</dl>
<p><a name="module_app"></a></p>
<h2 id="app">app</h2>
<p>Express app instance.</p>
<p><a name="module_services/cron"></a></p>
<h2 id="servicescron">services/cron</h2>
<p>Cron job service for periodic transaction fetching.</p>
<ul class="incremental">
    <li>Schedules a job to run every 20 second.</li>
    <li>Calls runIncremental to fetch new transactions.</li>
    <li>Logs the result after each execution.</li>
</ul>
<p><a name="module_services/network"></a></p>
<h2 id="servicesnetwork">services/network</h2>
<p>Network service module for external API clients.</p>
<ul class="incremental">
    <li>Exports pre-configured Axios instances for Odoo and SteVe APIs.</li>
    <li>Tests connections to SteVe and Odoo on module load.</li>
</ul>
<p><a name="module_services/odoo"></a></p>
<h2 id="servicesodoo">services/odoo</h2>
<p>Odoo integration service: user creation, login, key rotation, and
    invoicing API.</p>
<ul class="incremental">
    <li><a href="#module_services/odoo">services/odoo</a>
        <ul class="incremental">
            <li><a
                    href="#module_services/odoo..createOdooUser">~createOdooUser(user)</a></li>
            <li><a
                    href="#module_services/odoo..getOdooPortalLogin">~getOdooPortalLogin(user)</a>
                => <code>string</code></li>
            <li><a
                    href="#module_services/odoo..rotateOdooUserAuth">~rotateOdooUserAuth(user)</a>
                => <code>Promise.&lt;Object&gt;</code></li>
            <li><a
                    href="#module_services/odoo..createOdooTxnInvoice">~createOdooTxnInvoice(db_txn)</a>
                => <code>Promise.&lt;string&gt;</code></li>
        </ul>
    </li>
</ul>
<p><a name="module_services/odoo..createOdooUser"></a></p>
<h3
        id="servicesodoocreateodoouseruser">services/odoo~createOdooUser(user)</h3>
<p>Creates a new Odoo user.</p>
<ul class="incremental">
    <li>Throws if the user already has an Odoo user ID.</li>
    <li>Sends a POST request to Odoo to create the user.</li>
    <li>Verifies the response hash for integrity.</li>
    <li>Stores Odoo credentials in the database.</li>
    <li>Logs the creation activity.</li>
</ul>
<p><strong>Kind</strong>: inner method of <a
        href="#module_services/odoo"><code>services/odoo</code></a><br/>
    <strong>Throws</strong>:</p>
<ul class="incremental">
    <li><code>ValidationError</code><code>SystemError</code> On validation
        or Odoo errors.
    </li>
</ul>
<p><a name="module_services/odoo..getOdooPortalLogin"></a></p>
<h3
        id="servicesodoogetodooportalloginuser-string">services/odoo~getOdooPortalLogin(user)
    => <code>string</code></h3>
<p>Generates a secure Odoo portal login URL for the given user.</p>
<ul class="incremental">
    <li>Validates the user object.</li>
    <li>Fetches Odoo credentials from the database.</li>
    <li>Constructs a login URL with required query parameters for
        authentication.
    </li>
    <li>Throws if credentials are missing or invalid.</li>
</ul>
<p><strong>Kind</strong>: inner method of <a
        href="#module_services/odoo"><code>services/odoo</code></a><br/>
    <strong>Returns</strong>: <code>string</code> - Odoo portal login
    URL.<br/>
    <strong>Throws</strong>:</p>
<ul class="incremental">
    <li><code>ValidationError</code> If user or credentials are
        invalid.
    </li>
</ul>
<p><a name="module_services/odoo..rotateOdooUserAuth"></a></p>
<h3
        id="servicesodoorotateodoouserauthuser-promise.object">services/odoo~rotateOdooUserAuth(user)
    => <code>Promise.&lt;Object&gt;</code></h3>
<p>Rotates the Odoo user API key for the given user.</p>
<ul class="incremental">
    <li>Validates the user object.</li>
    <li>Fetches current Odoo credentials from the database.</li>
    <li>Requests a new API key from Odoo and verifies the response
        hash.
    </li>
    <li>Updates the database with the new key and salt.</li>
    <li>Returns the updated Odoo credentials.</li>
</ul>
<p><strong>Kind</strong>: inner method of <a
        href="#module_services/odoo"><code>services/odoo</code></a><br/>
    <strong>Returns</strong>: <code>Promise.&lt;Object&gt;</code> - Updated
    Odoo credentials.<br/>
    <strong>Throws</strong>:</p>
<ul class="incremental">
    <li><code>ValidationError</code><code>SystemError</code> On validation
        or Odoo errors.
    </li>
</ul>
<p><a name="module_services/odoo..createOdooTxnInvoice"></a></p>
<h3
        id="servicesodoocreateodootxninvoicedb_txn-promise.string">services/odoo~createOdooTxnInvoice(db_txn)
    => <code>Promise.&lt;string&gt;</code></h3>
<p>Creates a bill/invoice in Odoo for a given transaction.</p>
<ul class="incremental">
    <li>Validates the transaction object.</li>
    <li>Fetches Odoo credentials for the user.</li>
    <li>Prepares invoice line data.</li>
    <li>Sends a POST request to Odoo to create the invoice.</li>
    <li>Throws if creation fails.</li>
</ul>
<p><strong>Kind</strong>: inner method of <a
        href="#module_services/odoo"><code>services/odoo</code></a><br/>
    <strong>Returns</strong>: <code>Promise.&lt;string&gt;</code> - The
    created bill ID.<br/>
    <strong>Throws</strong>:</p>
<ul class="incremental">
    <li><code>ValidationError</code><code>SystemError</code> On validation
        or Odoo errors.
    </li>
</ul>
<p><a name="module_services/steve_transactions"></a></p>
<h2 id="servicessteve_transactions">services/steve_transactions</h2>
<p>Incremental fetch of STOPPED transactions since last high‑water mark
    (T0).</p>
<p>High‑Water Mark Concept: We persist the timestamp of the latest
    processed transaction (the “high‑water mark” or T0). On each run, we
    only fetch transactions whose stopTimestamp is strictly greater than T0.
    After processing, we update T0 to the maximum stopTimestamp seen. This
    ensures: • No overlap or reprocessing of already handled transactions. •
    No gaps: even if a transaction ends just after T0, it will be fetched
    next run. • Linear, efficient incremental retrieval without maintaining
    complex windows.</p>
<ul class="incremental">
    <li><a
            href="#module_services/steve_transactions">services/steve_transactions</a>
        <ul class="incremental">
            <li><a
                    href="#module_services/steve_transactions..fetchSince">~fetchSince(since)</a>
                => <code>Promise.&lt;Array.&lt;Object&gt;&gt;</code></li>
            <li><a
                    href="#module_services/steve_transactions..processSince">~processSince(txns)</a>
                => <code>Promise.&lt;DateTime&gt;</code></li>
            <li><a
                    href="#module_services/steve_transactions..runIncremental">~runIncremental()</a>
                => <code>Promise.&lt;{fetched: number, high_water_mark:
                    DateTime}&gt;</code></li>
            <li><a
                    href="#module_services/steve_transactions..runFull">~runFull()</a> =>
                <code>Promise.&lt;{fetched: number, high_water_mark:
                    DateTime}&gt;</code></li>
            <li><a
                    href="#module_services/steve_transactions..runToday">~runToday()</a> =>
                <code>Promise.&lt;{fetched: number, high_water_mark:
                    DateTime}&gt;</code></li>
        </ul>
    </li>
</ul>
<p><a name="module_services/steve_transactions..fetchSince"></a></p>
<h3
        id="servicessteve_transactionsfetchsincesince-promise.array.object">
    services/steve_transactions~fetchSince(since)
    => <code>Promise.&lt;Array.&lt;Object&gt;&gt;</code></h3>
<p>Fetch STOPPED transactions since a given timestamp (exclusive) If no
    timestamp is provided, fetch all transactions</p>
<p><strong>Kind</strong>: inner method of <a
        href="#module_services/steve_transactions"><code>services/steve_transactions</code></a><br/>
    <strong>Returns</strong>:
    <code>Promise.&lt;Array.&lt;Object&gt;&gt;</code> - Array of
    transactions<br/>
    <a name="module_services/steve_transactions..processSince"></a></p>
<h3
        id="servicessteve_transactionsprocesssincetxns-promise.datetime">services/steve_transactions~processSince(txns)
    => <code>Promise.&lt;DateTime&gt;</code></h3>
<p>Record and create bills for transactions/charging sessions</p>
<p><strong>Kind</strong>: inner method of <a
        href="#module_services/steve_transactions"><code>services/steve_transactions</code></a><br/>
    <strong>Returns</strong>: <code>Promise.&lt;DateTime&gt;</code> - The
    new high‑water mark (max stopTimestamp)<br/>
    <a name="module_services/steve_transactions..runIncremental"></a></p>
<h3
        id="servicessteve_transactionsrunincremental-promise.fetched-number-high_water_mark-datetime">
    services/steve_transactions~runIncremental()
    => <code>Promise.&lt;{fetched: number, high_water_mark:
    DateTime}&gt;</code></h3>
<p>Run incremental billing cycle: fetch and process since last T0</p>
<p><strong>Kind</strong>: inner method of <a
        href="#module_services/steve_transactions"><code>services/steve_transactions</code></a><br/>
    <a name="module_services/steve_transactions..runFull"></a></p>
<h3
        id="servicessteve_transactionsrunfull-promise.fetched-number-high_water_mark-datetime">
    services/steve_transactions~runFull()
    => <code>Promise.&lt;{fetched: number, high_water_mark:
    DateTime}&gt;</code></h3>
<p>Fetches all transactions from Steve, processes them, and updates the
    high-water mark. Use for a full sync (no time filter).</p>
<p><strong>Kind</strong>: inner method of <a
        href="#module_services/steve_transactions"><code>services/steve_transactions</code></a><br/>
    <a name="module_services/steve_transactions..runToday"></a></p>
<h3
        id="servicessteve_transactionsruntoday-promise.fetched-number-high_water_mark-datetime">
    services/steve_transactions~runToday()
    => <code>Promise.&lt;{fetched: number, high_water_mark:
    DateTime}&gt;</code></h3>
<p>Fetch and process all of today’s transactions and updates the
    high-water mark.</p>
<p><strong>Kind</strong>: inner method of <a
        href="#module_services/steve_transactions"><code>services/steve_transactions</code></a><br/>
    <a name="module_services/steve_user"></a></p>
<h2 id="servicessteve_user">services/steve_user</h2>
<p>SteVe User Service</p>
<p>Provides functions to create, fetch, block, and unblock users in the
    SteVe OCPP backend. - createSteveUser: Creates a new user in SteVe with
    the given RFID. - getSteveUser: Fetches a user from SteVe by RFID. -
    blockSteveUser: Blocks a user in SteVe (sets maxActiveTransactionCount
    to 0). - unblockSteveUser: Unblocks a user in SteVe (sets
    maxActiveTransactionCount to 1).</p>
<p>All functions validate input and handle errors using custom error
    types.</p>
<ul class="incremental">
    <li><a href="#module_services/steve_user">services/steve_user</a>
        <ul class="incremental">
            <li><a
                    href="#module_services/steve_user..createSteveUser">~createSteveUser(user,
                [blocked])</a> => <code>Promise.&lt;Object&gt;</code></li>
            <li><a
                    href="#module_services/steve_user..getSteveUser">~getSteveUser(user_rfid)</a>
                => <code>Promise.&lt;(Array.&lt;Object&gt;|null)&gt;</code></li>
            <li><a
                    href="#module_services/steve_user..blockSteveUser">~blockSteveUser(user)</a></li>
            <li><a
                    href="#module_services/steve_user..unblockSteveUser">~unblockSteveUser(user)</a></li>
        </ul>
    </li>
</ul>
<p><a name="module_services/steve_user..createSteveUser"></a></p>
<h3
        id="servicessteve_usercreatesteveuseruser-blocked-promise.object">services/steve_user~createSteveUser(user,
    [blocked]) => <code>Promise.&lt;Object&gt;</code></h3>
<p>Creates a new user in SteVe with the given RFID. - Checks if the user
    already exists. - Creates the user with the specified block status. -
    Validates the response and stores the steve_id in the database. -
    Returns the created user data.</p>
<p><strong>Kind</strong>: inner method of <a
        href="#module_services/steve_user"><code>services/steve_user</code></a><br/>
    <strong>Returns</strong>: <code>Promise.&lt;Object&gt;</code> - The
    created user data from SteVe.<br/>
    <strong>Throws</strong>:</p>
<ul class="incremental">
    <li><code>ValidationError</code><code>Error</code> If validation fails
        or creation fails.
    </li>
</ul>
<p><a name="module_services/steve_user..getSteveUser"></a></p>
<h3
        id="servicessteve_usergetsteveuseruser_rfid-promise.array.objectnull">
    services/steve_user~getSteveUser(user_rfid)
    => <code>Promise.&lt;(Array.&lt;Object&gt;|null)&gt;</code></h3>
<p>Fetches a user from SteVe by RFID. Returns null if not found, throws
    if multiple found or on error. Validates the user data.</p>
<p><strong>Kind</strong>: inner method of <a
        href="#module_services/steve_user"><code>services/steve_user</code></a><br/>
    <strong>Returns</strong>:
    <code>Promise.&lt;(Array.&lt;Object&gt;|null)&gt;</code> - User data
    array or null if not found.<br/>
    <strong>Throws</strong>:</p>
<ul class="incremental">
    <li><code>ValidationError</code><code>Error</code> On invalid input or
        fetch error.
    </li>
</ul>
<p><a name="module_services/steve_user..blockSteveUser"></a></p>
<h3
        id="servicessteve_userblocksteveuseruser">services/steve_user~blockSteveUser(user)</h3>
<p>Blocks a user in SteVe by setting their maxActiveTransactionCount to
    0. Validates input, updates the user, checks the block status, and logs
    the action.</p>
<p><strong>Kind</strong>: inner method of <a
        href="#module_services/steve_user"><code>services/steve_user</code></a><br/>
    <strong>Throws</strong>:</p>
<ul class="incremental">
    <li><code>ValidationError</code><code>Error</code> If input is invalid
        or block fails.
    </li>
</ul>
<p><a name="module_services/steve_user..unblockSteveUser"></a></p>
<h3
        id="servicessteve_userunblocksteveuseruser">services/steve_user~unblockSteveUser(user)</h3>
<p>Unblocks a user in SteVe by setting their maxActiveTransactionCount
    to 1. Validates input, updates the user, checks the unblock status, and
    logs the action.</p>
<p><strong>Kind</strong>: inner method of <a
        href="#module_services/steve_user"><code>services/steve_user</code></a><br/>
    <strong>Throws</strong>:</p>
<ul class="incremental">
    <li><code>ValidationError</code><code>Error</code> If input is invalid
        or unblock fails.
    </li>
</ul>
<p><a name="module_utils/oidc_config"></a></p>
<h2 id="utilsoidc_config">utils/oidc_config</h2>
<p>OIDC configuration for authentication middleware. - Uses environment
    variables for secrets and endpoints. - Customizes authorization
    parameters and routes. - Handles user session after authentication
    callback.</p>
<p><a name="module_utils/steve"></a></p>
<h2 id="utilssteve">utils/steve</h2>
<p>Utility functions for Steve user data.</p>
<p><a name="module_utils/steve..validateSteveUser"></a></p>
<h3
        id="utilsstevevalidatesteveuserresponse_data-userrfid">utils/steve~validateSteveUser(response_data,
    userRfid)</h3>
<p>Validates Steve user response data. - Checks structure using Joi
    schema. - Ensures idTag matches the expected RFID.</p>
<p><strong>Kind</strong>: inner method of <a
        href="#module_utils/steve"><code>utils/steve</code></a><br/>
    <strong>Throws</strong>:</p>
<ul class="incremental">
    <li><code>ValidationError</code> If validation fails.</li>
</ul>
<p><a name="module_app"></a></p>
<h2 id="app-1">app</h2>
<p>Express app instance.</p>
<p><a name="AppError"></a></p>
<h2 id="apperror">AppError</h2>
<p>Base class for custom application errors</p>
<p><strong>Kind</strong>: global class<br/>
    <a name="winston"></a></p>
<h2 id="winston-winston">winston : <a
        href="#winston"><code>winston</code></a></h2>
<p>Creates a logger instance with specified configuration.</p>
<p><strong>Kind</strong>: global constant<br/>
    <a name="logger"></a></p>
<h2 id="logger">logger</h2>
<p>Application Error Codes</p>
<p>This module defines standardized error codes and messages for the
    application. Errors are grouped by category and include codes, HTTP
    status codes, and messages.</p>
<p><strong>Kind</strong>: global constant<br/>
    <a name="generateOdooHash"></a></p>
<h2 id="generateodoohashmessage-secret-string">generateOdooHash(message,
    secret) => <code>string</code></h2>
<p>Generate HMAC signature matching Odoo implementation</p>
<p><strong>Kind</strong>: global function<br/>
    <strong>Returns</strong>: <code>string</code> - - Hexadecimal
    signature<br/>
    <a name="generateSalt"></a></p>
<h2 id="generatesaltlength-string">generateSalt(length) =>
    <code>string</code></h2>
<p>Generate a cryptographically secure random salt</p>
<p><strong>Kind</strong>: global function<br/>
    <strong>Returns</strong>: <code>string</code> - - salt string<br/>
    <a name="identifyUser"></a></p>
<h2
        id="identifyuseridentifier-options-promise.object">identifyUser(identifier,
    options) => <code>Promise.&lt;Object&gt;</code></h2>
<p>Gets a user by either user_id or oauth_id</p>
<p><strong>Kind</strong>: global function<br/>
    <strong>Returns</strong>: <code>Promise.&lt;Object&gt;</code> - - User
    object<br/>
    <strong>Throws</strong>:</p>
<ul class="incremental">
    <li><code>ValidationError</code> - If user not found or doesn’t meet
        requirements
    </li>
</ul>
<p><a name="userOperations"></a></p>
<h2
        id="useroperationsoidc_user-promise.object">userOperations(oidc_user) =>
    <code>Promise.&lt;Object&gt;</code></h2>
<p>Handles user creation and linking with external systems.</p>
<ul class="incremental">
    <li>Checks if a user exists by OIDC ID.</li>
    <li>If not, creates a new user with a random RFID (for
        development).
    </li>
    <li>Ensures the user is registered in Odoo and Steve systems.</li>
    <li>Returns the up-to-date user object.</li>
</ul>
<p><strong>Kind</strong>: global function<br/>
    <strong>Returns</strong>: <code>Promise.&lt;Object&gt;</code> - User
    object from the database.<br/>
    <a name="fmt"></a></p>
<h2 id="fmtdt-toutc-string">fmt(dt, toUTC) => <code>string</code></h2>
<p>Format a Luxon DateTime into SteVe’s expected ISO string (no Z)</p>
<p><strong>Kind</strong>: global function<br/>
    <a name="createError"></a></p>
<h2
        id="createerrorerrordef-custommessage-originalerror-object">createError(errorDef,
    [customMessage], [originalError]) => <code>Object</code></h2>
<p>Create an application error with standard format</p>
<p><strong>Kind</strong>: global function<br/>
    <strong>Returns</strong>: <code>Object</code> - Formatted error
    object<br/>
    <a name="appErrorHandler"></a></p>
<h2 id="apperrorhandler">appErrorHandler()</h2>
<p>Express error handler for AppErrors</p>
<p><strong>Kind</strong>: global function<br/>
    <a name="handleQueryError"></a></p>
<h2 id="handlequeryerrorerror-operation">handleQueryError(error,
    operation)</h2>
<p>Handles query errors.</p>
<p><strong>Kind</strong>: global function<br/>
    <strong>Throws</strong>:</p>
<ul class="incremental">
    <li><code>Error</code> - The error that happened during the
        operation.
    </li>
</ul>
<p><a name="getUsers"></a></p>
<h2 id="getusersfilters-options-promise.array">getUsers(filters,
    options) => <code>Promise.&lt;Array&gt;</code></h2>
<p>Gets users based on dynamic filter parameters.</p>
<p><strong>Kind</strong>: global function<br/>
    <strong>Returns</strong>: <code>Promise.&lt;Array&gt;</code> - - The
    matching users<br/>
    <strong>Throws</strong>:</p>
<ul class="incremental">
    <li><code>DatabaseError</code> - If the database operation fails</li>
</ul>
<p><strong>Example</strong></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb1-1"><a
        aria-hidden="true" href="#cb1-1" tabindex="-1"></a><span class="fu">getUsers</span>({ <span class="dt">first_name</span><span
        class="op">:</span> <span class="st">&#39;John&#39;</span> }) <span class="op">-</span> Get all users named John</span>
<span id="cb1-2"><a aria-hidden="true" href="#cb1-2" tabindex="-1"></a><span class="fu">getUsers</span>({ <span
        class="dt">active</span><span class="op">:</span> <span class="kw">true</span> }<span
        class="op">,</span> { <span class="dt">limit</span><span class="op">:</span> <span class="dv">10</span><span
        class="op">,</span> <span class="dt">offset</span><span class="op">:</span> <span class="dv">20</span> }) <span
        class="op">-</span> Get <span class="dv">10</span> active users<span class="op">,</span> skipping first <span
        class="dv">20</span></span>
<span id="cb1-3"><a aria-hidden="true" href="#cb1-3" tabindex="-1"></a><span class="fu">getUsers</span>({}<span
        class="op">,</span> { <span class="dt">orderBy</span><span class="op">:</span> <span class="st">&#39;created_at&#39;</span><span
        class="op">,</span> <span class="dt">orderDirection</span><span class="op">:</span> <span class="st">&#39;DESC&#39;</span> }) <span
        class="op">-</span> Get all users ordered by creation date descending</span></code></pre>
</div>
<p><a name="getUserUnique"></a></p>
<h2 id="getuseruniquefilters-promise.objectnull">getUserUnique(filters)
    => <code>Promise.&lt;(Object|null)&gt;</code></h2>
<p>Gets a single user with uniqueness validation. Throws an error if
    multiple users match the criteria.</p>
<p><strong>Kind</strong>: global function<br/>
    <strong>Returns</strong>: <code>Promise.&lt;(Object|null)&gt;</code> - -
    The matching user or null if not found<br/>
    <strong>Throws</strong>:</p>
<ul class="incremental">
    <li><code>DatabaseError</code> - database operation fails</li>
    <li><code>ValidationError</code> - if multiple users match the
        criteria
    </li>
</ul>
<p><a name="getUserOdooCredentials"></a></p>
<h2
        id="getuserodoocredentialsuser_id-promise.objectnull">getUserOdooCredentials(user_id)
    => <code>Promise.&lt;(Object|null)&gt;</code></h2>
<p>Retrieves the latest valid Odoo API key credentials for a user.
    Returns null if no credentials are found.</p>
<p><strong>Kind</strong>: global function<br/>
    <strong>Returns</strong>: <code>Promise.&lt;(Object|null)&gt;</code> -
    The credentials object or null.<br/>
    <strong>Throws</strong>:</p>
<ul class="incremental">
    <li><code>ValidationError</code><code>DatabaseError</code> On missing
        parameters or query error.
    </li>
</ul>
<p><a name="rotateOdooUserKey"></a></p>
<h2
        id="rotateodoouserkeyuser_id-old_key_id-new_key-new_key_salt-promise.boolean">rotateOdooUserKey(user_id,
    old_key_id, new_key, new_key_salt) =>
    <code>Promise.&lt;boolean&gt;</code></h2>
<p>Rotates a user’s Odoo API key. Revokes the old key and inserts a new
    one for the user.</p>
<p><strong>Kind</strong>: global function<br/>
    <strong>Returns</strong>: <code>Promise.&lt;boolean&gt;</code> - True if
    rotation is successful.<br/>
    <strong>Throws</strong>:</p>
<ul class="incremental">
    <li><code>ValidationError</code><code>DatabaseError</code> On missing
        parameters or DB error.
    </li>
</ul>
<p><a name="setSteveUserParamaters"></a></p>
<h2
        id="setsteveuserparamatersuser-steve_id-promise.objectundefined">setSteveUserParamaters(user,
    steve_id) => <code>Promise.&lt;(Object|undefined)&gt;</code></h2>
<p>Sets the SteVe user ID for a user in the database.</p>
<p><strong>Kind</strong>: global function<br/>
    <strong>Returns</strong>:
    <code>Promise.&lt;(Object|undefined)&gt;</code> - The updated user row
    or undefined.<br/>
    <strong>Throws</strong>:</p>
<ul class="incremental">
    <li><code>ValidationError</code> If required parameters are
        missing.
    </li>
    <li><code>Error</code> If the update fails.</li>
</ul>
<p><a name="recordActivityLog"></a></p>
<h2
        id="recordactivityloguser_id-event_type-target-rfid">recordActivityLog(user_id,
    event_type, target, rfid)</h2>
<p>Records an activity event for a user in the activity log.</p>
<p><strong>Kind</strong>: global function<br/>
    <a name="recordTransaction"></a></p>
<h2 id="recordtransactiontx-promise.object">recordTransaction(tx) =>
    <code>Promise.&lt;Object&gt;</code></h2>
<p>Record a transaction record into the
    <code>charging_transactions</code> table. If transaction already exists
    and is complete, returns it without modification. Otherwise, inserts a
    new record with proper user association.</p>
<p><strong>Kind</strong>: global function<br/>
    <strong>Returns</strong>: <code>Promise.&lt;Object&gt;</code> - db_txn -
    The transaction record from database<br/>
    <a name="setLastStopTimestamp"></a></p>
<h2
        id="setlaststoptimestampnew_watermark-promise.void">setLastStopTimestamp(new_watermark)
    => <code>Promise.&lt;void&gt;</code></h2>
<p>Sets the last stop timestamp watermark. Inserts or updates the
    <code>watermark</code> table with the given timestamp.</p>
<p><strong>Kind</strong>: global function<br/>
    <a name="getLastStopTimestamp"></a></p>
<h2
        id="getlaststoptimestamp-promise.datetimenull">getLastStopTimestamp() =>
    <code>Promise.&lt;(DateTime|null)&gt;</code></h2>
<p>Retrieves the most recent <code>last_stop_timestamp</code> from the
    watermark table. Returns a Luxon DateTime if found, otherwise null.</p>
<p><strong>Kind</strong>: global function<br/>
    <strong>Returns</strong>: <code>Promise.&lt;(DateTime|null)&gt;</code> -
    The latest stop timestamp or null if not found.<br/>
    <strong>Throws</strong>:</p>
<ul class="incremental">
    <li><code>DatabaseError</code> On query error.</li>
</ul>
<p><a name="saveInvoiceId"></a></p>
<h2 id="saveinvoiceidtxn-invoice_id-promise.void">saveInvoiceId(txn,
    invoice_id) => <code>Promise.&lt;void&gt;</code></h2>
<p>Updates the <code>invoice_ref</code> field for a transaction in
    <code>charging_transactions</code>.</p>
<p><strong>Kind</strong>: global function<br/>
    <strong>Throws</strong>:</p>
<ul class="incremental">
    <li><code>DatabaseError</code><code>ValidationError</code> On query
        error.
    </li>
</ul>
</body>
</html>
